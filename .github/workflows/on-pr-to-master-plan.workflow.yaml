#name: Update PR with TF plan

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master]

name: Update PR with kitchen TF plan


jobs:
  # Generate kitchen's TF plan.
  
  kitchen-plan:
    name: Submit kitchen TF plan
    uses: ./.github/workflows/terraform-plan.template.yaml@master
    with:
      secrets_keys_list: "terraformApiToken"
    secrets:
      key_vault_credentials: ${{ secrets.AZURE_CREDENTIALS }}
      key_vault_name: ${{ secrets.AZURE_KEY_VAULT_NAME }}
    
  # Post a comment kitchen's TF plan.
  submit-plan-result:
    name: Submit TF plan
    needs: kitchen-plan
    uses: ./.github/workflows/submit-pr-comment.template.yaml
    with:
      comment_text: |
        '#### Terraform Format and Style ğŸ–Œ\`${{ needs.kitchen-plan.outputs.formatStatus }}\`
         #### Terraform Initialization âš™ï¸\`${{ needs.kitchen-plan.outputs.initStatus }}\`
         #### Terraform Validation ğŸ¤–\`${{ needs.kitchen-plan.outputs.validationStatus }}\`
         #### Terraform Plan ğŸ“–\`${{ needs.kitchen-plan.outputs.planStatus }}\`

         <details><summary>Show Plan</summary>

          \`\`\`\n
          ${{ needs.kitchen-plan.outputs.planDetails }}
          \`\`\`

          </details>

          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*'
